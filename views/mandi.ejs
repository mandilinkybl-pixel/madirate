<!DOCTYPE html>
<html>
<head>
  <title>Mandi Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(120deg, #c2e9fb 0%, #f8ffae 100%);
    }
    .sidebar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #fff;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      width: 240px;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 10;
      display: flex;
      flex-direction: column;
      transition: width 0.3s;
    }
    .sidebar.collapsed {
      width: 65px !important;
      min-width: 65px !important;
    }
    .sidebar .sidebar-header {
      font-size: 1.5rem;
      font-weight: bold;
      padding: 1rem 0 0.5rem 0;
      text-align: center;
      letter-spacing: 2px;
      position: relative;
    }
    .sidebar .logo {
      width: 54px;
      height: 54px;
      object-fit: contain;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 0.5rem;
      margin-top: 1rem;
    }
    .sidebar .nav-link {
      color: #fff !important;
      font-weight: 500;
      border-radius: 8px;
      margin-bottom: 4px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.7rem 1rem;
    }
    .sidebar .nav-link.active, .sidebar .nav-link:hover {
      background: rgba(255,255,255,0.15);
    }
    .sidebar .nav-link i {
      font-size: 1.3rem;
      min-width: 26px;
      text-align: center;
    }
    .sidebar .collapse-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.4rem;
      position: absolute;
      top: 18px;
      right: 18px;
      z-index: 2;
      transition: color 0.2s;
    }
    .sidebar .collapse-btn:focus {
      outline: none;
    }
    .sidebar.collapsed .sidebar-header,
    .sidebar.collapsed .logo,
    .sidebar.collapsed .nav-link span,
    .sidebar.collapsed .mt-auto {
      display: none !important;
    }
    .sidebar.collapsed .nav-link {
      justify-content: center;
      padding-left: 0;
    }
    .sidebar.collapsed .nav-link i {
      font-size: 1.7rem;
    }
    .main-content {
      margin-left: 240px;
      padding: 2rem 2rem 1rem 2rem;
      transition: margin-left 0.3s;
    }
    @media (max-width: 768px) {
      .main-content {
        margin-left: 65px !important;
        padding: 1rem;
      }
      .sidebar {
        width: 65px !important;
        min-width: 65px !important;
      }
      .sidebar .sidebar-header,
      .sidebar .logo,
      .sidebar .nav-link span,
      .sidebar .mt-auto {
        display: none !important;
      }
      .sidebar .nav-link {
        justify-content: center;
        padding-left: 0;
      }
    }
    .table-responsive {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .bg-white.p-3 {
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.09);
    }
    .btn-primary {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border: none;
    }
    .btn-success {
      background: linear-gradient(90deg, #43ea7f 0%, #86a8e7 100%);
      border: none;
    }
    .btn-danger {
      background: linear-gradient(90deg, #fa5a5a 0%, #fda085 100%);
      border: none;
    }
  </style>
</head>
<body>
  <!-- Sidebar with logo -->
  <div class="sidebar" id="sidebar">
    <button class="collapse-btn" id="collapseBtn" title="Collapse/Expand Sidebar"><i class="bi bi-list"></i></button>
    <div class="sidebar-header">
      
      Mandi Panel
    </div>
<nav class="nav flex-column px-3 mt-2">
  <a href="/" class="nav-link active"><i class="bi bi-house-door"></i> <span>Reports</span></a>
  <a href="/mandi-rates" class="nav-link"><i class="bi bi-plus-square"></i> <span>Add MandiRates</span></a>
  <a href="/mandi" class="nav-link"><i class="bi bi-file-earmark-bar-graph"></i> <span>Add Mandi</span></a>
  <a href="/commodities" class="nav-link"><i class="bi bi-clock-history"></i> <span>Commodities</span></a>
  <a href="/states" class="nav-link"><i class="bi bi-gear"></i> <span>States</span></a>
  <a href="/logout" class="nav-link"><i class="bi bi-box-arrow-right"></i> <span>Logout</span></a>
</nav>
    <div class="mt-auto px-3 pb-4 small text-center" style="opacity:0.7;">
      <i class="bi bi-person-circle"></i> Admin Panel
    </div>
  </div>

  <div class="main-content" id="mainContent">
    <h2 class="mb-3 fw-bold text-primary">Mandi Management</h2>
    <% if (error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <!-- Multi Add Form: Select one state, add many mandi names -->
    <form action="/mandi/add" method="POST" class="mb-4 bg-white p-3 rounded shadow-sm border" id="multiAddForm">
      <div class="row g-2 mb-2">
        <div class="col-md-10">
          <select name="state" class="form-select" required>
            <option value="">Select State</option>
            <% states.forEach(st => { %>
              <option value="<%= st._id %>"><%= st.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2"></div>
      </div>
      <div id="mandiRows">
        <div class="row g-2 mandi-row">
          <div class="col-md-10">
            <input type="text" name="mandis[0][name]" class="form-control" placeholder="Mandi Name" required>
          </div>
          <div class="col-md-2 d-flex align-items-center">
            <button type="button" class="btn btn-danger remove-row d-none"><i class="bi bi-x-lg"></i></button>
          </div>
        </div>
      </div>
      <div class="mt-2 d-flex">
        <button type="button" class="btn btn-outline-primary me-2" id="addMandiRow"><i class="bi bi-plus-circle"></i> Add More Mandis</button>
        <button class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Mandis</button>
      </div>
    </form>

    <h4 class="fw-bold text-secondary">All Mandis</h4>
    <div class="table-responsive bg-white rounded shadow-sm border mt-3">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Mandi Name</th>
            <th>State</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% mandis.forEach((m, index) => { %>
            <tr>
              <td><%= index + 1 %></td>
              <td>
                <form action="/mandi/update" method="POST" class="d-flex gap-2">
                  <input type="hidden" name="id" value="<%= m._id %>">
                  <input type="text" name="name" value="<%= m.name %>" class="form-control">
              </td>
              <td>
                  <select name="state" class="form-select">
                    <% states.forEach(st => { %>
                      <option value="<%= st._id %>" <%= (m.state && m.state._id.toString() === st._id.toString()) ? 'selected' : '' %>><%= st.name %></option>
                    <% }) %>
                  </select>
              </td>
              <td>
                  <button class="btn btn-success btn-sm"><i class="bi bi-check-lg"></i> Save</button>
                  <a href="/mandi/delete/<%= m._id %>" class="btn btn-danger btn-sm" onclick="return confirm('Delete this mandi?')"><i class="bi bi-trash"></i> Delete</a>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Collapsible Sidebar
    const sidebar = document.getElementById('sidebar');
    const collapseBtn = document.getElementById('collapseBtn');
    const mainContent = document.getElementById('mainContent');
    let collapsed = false;
    collapseBtn.onclick = function() {
      collapsed = !collapsed;
      sidebar.classList.toggle('collapsed', collapsed);
      mainContent.style.marginLeft = collapsed ? '65px' : '240px';
    };

    // Dynamic multi-row Mandi Add logic
    let rowCount = 1;
    document.getElementById('addMandiRow').onclick = function() {
      const rowsDiv = document.getElementById('mandiRows');
      const newRow = document.createElement('div');
      newRow.className = 'row g-2 mandi-row mt-2';
      newRow.innerHTML = `
        <div class="col-md-10">
          <input type="text" name="mandis[${rowCount}][name]" class="form-control" placeholder="Mandi Name" required>
        </div>
        <div class="col-md-2 d-flex align-items-center">
          <button type="button" class="btn btn-danger remove-row"><i class="bi bi-x-lg"></i></button>
        </div>
      `;
      rowsDiv.appendChild(newRow);
      rowCount++;
      updateRemoveButtons();
    };

    function updateRemoveButtons() {
      const rows = document.querySelectorAll('.mandi-row');
      rows.forEach((row, idx) => {
        const btn = row.querySelector('.remove-row');
        if (btn) {
          btn.style.display = rows.length > 1 ? 'inline-block' : 'none';
          btn.onclick = function() {
            row.remove();
            updateRemoveButtons();
          };
        }
      });
    }
    updateRemoveButtons();
  </script>
</body>
</html>